<?php
// Include direct access protection
require_once 'direct_access_protection.php';

// Include required authentication check to protect this page
require_once 'includes/required_auth.php';

// Include database connection
require_once 'includes/db_connect.php';

?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Regional Institute of Nursing - Student Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Dashboard, Student Portal, Nursing Institute" name="keywords">
    <meta content="Regional Institute of Nursing Student Dashboard" name="description">

    <!-- Immediate redirect if directly accessed -->
    <script>
        // Check if we're being loaded directly (not through PHP include)
        if (typeof window.__INCLUDED__ === 'undefined') {
            window.location.replace('dashboard.php');
        }
    </script>

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="../lib/animate/animate.min.css" rel="stylesheet">
    <link href="../lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../css/style.css" rel="stylesheet">
    
    <!-- Admission CSS -->
    <link href="css/admission.css" rel="stylesheet">
</head>

<body>
    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->


    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
        <a href="../index.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <img class="d-none d-md-block d-lg-block" src="../img/rin_logo_new.png" width="75" height="73" alt="Logo">
            <h2 class="m-0 text-primary">
                Regional Institute of Nursing
            </h2>
        </a>
        <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <a href="../index.html" class="nav-item nav-link">Home</a>
                <a href="../about.html" class="nav-item nav-link">About</a>
                <a href="../facilities.html" class="nav-item nav-link">Facilities</a>
                <a href="../courses.html" class="nav-item nav-link">Courses</a>
                <a href="../admission.html" class="nav-item nav-link active">Admission</a>
                <a href="../fees.html" class="nav-item nav-link">Fees</a>
                <a href="../contact.html" class="nav-item nav-link">Contact</a>
                <a href="dashboard.php" class="nav-item nav-link">Dashboard</a>
                <a href="includes/logout.php" class="nav-item nav-link text-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>
    <!-- Navbar End -->


    <!-- Portal Header Start -->
    <div class="portal-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2><i class="fas fa-tachometer-alt me-2"></i>Student Dashboard</h2>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="text-white"><i class="fas fa-calendar-alt me-2"></i>Last Login: <span id="last-login-date">Loading...</span></span>
                </div>
            </div>
        </div>
    </div>
    <!-- Portal Header End -->


    <!-- Dashboard Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <div class="row g-4">
                <!-- Welcome Section -->
                <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="alert alert-primary">
                        <h4 class="alert-heading"><i class="fas fa-bell me-2"></i>Welcome, <?php echo htmlspecialchars($userData['first_name']); ?>!</h4>
                        <p class="mb-0">
                            <?php if($has_application): ?>
                                <?php if($application_data['status'] === 'submitted'): ?>
                                    Your application has been submitted successfully and is currently under review.
                                <?php else: ?>
                                    You have completed <?php echo $application_data['progress']; ?>% of your application. Please complete all sections to submit your application.
                                <?php endif; ?>
                            <?php else: ?>
                                Welcome to the admission portal! Start your application process by clicking the button below.
                            <?php endif; ?>
                        </p>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.3s">
                    <div class="portal-container">
                        <?php if($has_application): ?>
                        <!-- Application Status Section -->
                        <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.3s">
                            <div class="portal-container">
                                <?php if($application_data['status'] === 'submitted'): ?>
                                    <!-- Submitted Application View -->
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Application Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-success mb-4">
                                                <i class="fas fa-check-circle me-2"></i>Your application has been submitted successfully and is currently under review.
                                            </div>
                                            
                                            <div class="table-responsive">
                                                <table class="table table-bordered">
                                                    <tbody>
                                                        <tr>
                                                            <th width="200">Application ID</th>
                                                            <td><strong><?php echo htmlspecialchars($application_data['application_id']); ?></strong></td>
                                                            <th width="200">Status</th>
                                                            <td><span class="badge bg-primary"><?php echo ucfirst(htmlspecialchars($application_data['status'])); ?></span></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Full Name</th>
                                                            <td><?php echo !empty($application_data['full_name']) ? htmlspecialchars($application_data['full_name']) : '<em>Not provided</em>'; ?></td>
                                                            <th>Gender</th>
                                                            <td><?php echo !empty($application_data['gender']) ? ucfirst(htmlspecialchars($application_data['gender'])) : '<em>Not provided</em>'; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Date of Birth</th>
                                                            <td><?php echo !empty($application_data['dob']) ? date('d M Y', strtotime($application_data['dob'])) : '<em>Not provided</em>'; ?></td>
                                                            <th>Submitted On</th>
                                                            <td><?php echo !empty($application_data['submitted_at']) ? date('d M Y, h:i A', strtotime($application_data['submitted_at'])) : '<em>Not submitted</em>'; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <th>HSCE Board</th>
                                                            <td><?php echo !empty($application_data['hsce_board']) ? htmlspecialchars($application_data['hsce_board']) : '<em>Not provided</em>'; ?></td>
                                                            <th>HSCE Percentage</th>
                                                            <td><?php echo !empty($application_data['hsce_percentage']) ? htmlspecialchars($application_data['hsce_percentage']) . '%' : '<em>Not provided</em>'; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <th>HSCE Year</th>
                                                            <td><?php echo !empty($application_data['hsce_year']) ? htmlspecialchars($application_data['hsce_year']) : '<em>Not provided</em>'; ?></td>
                                                            <th>Application Progress</th>
                                                            <td>
                                                                <div class="progress">
                                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <a href="view_application.php?id=<?php echo $application_data['id']; ?>" class="btn btn-primary">
                                                    <i class="fas fa-eye me-2"></i>View Complete Application
                                                </a>
                                                <a href="download_application.php?id=<?php echo $application_data['id']; ?>" class="btn btn-success ms-2">
                                                    <i class="fas fa-download me-2"></i>Download Application
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                <?php else: ?>
                                    <!-- In Progress Application View -->
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Application Progress</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row align-items-center mb-4">
                                                <div class="col-md-3">
                                                    <h6 class="mb-0">Overall Progress</h6>
                                                </div>
                                                <div class="col-md-9">
                                                    <div class="progress">
                                                        <?php $progress = isset($application_data['progress']) ? (int)$application_data['progress'] : 0; ?>
                                                        <div class="progress-bar" role="progressbar" style="width: <?php echo $progress; ?>%" 
                                                             aria-valuenow="<?php echo $progress; ?>" 
                                                             aria-valuemin="0" 
                                                             aria-valuemax="100">
                                                            <?php echo $progress; ?>%
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Section</th>
                                                            <th width="150">Status</th>
                                                            <th width="100">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <?php foreach($sections as $section): ?>
                                                        <tr>
                                                            <td><?php echo htmlspecialchars($section['section_name']); ?></td>
                                                            <td>
                                                                <?php if($section['is_completed']): ?>
                                                                    <span class="badge bg-success">Completed</span>
                                                                <?php else: ?>
                                                                    <span class="badge bg-warning">Pending</span>
                                                                <?php endif; ?>
                                                            </td>
                                                            <td>
                                                                <a href="admission-form.php#section<?php echo $section['section_id']; ?>" class="btn btn-sm btn-primary">
                                                                    <?php echo $section['is_completed'] ? '<i class="fas fa-edit"></i>' : '<i class="fas fa-plus"></i>'; ?>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                        <?php endforeach; ?>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <a href="admission-form.php" class="btn btn-primary">
                                                    <i class="fas fa-edit me-2"></i>Continue Application
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                        <?php else: ?>
                        <!-- Start Application Section -->
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-file-alt text-primary" style="font-size: 4rem;"></i>
                            </div>
                            <h4 class="mb-3">Begin Your Journey with Us</h4>
                            <p class="text-muted mb-4">You haven't started your application yet. Click below to begin the admission process.</p>
                            <a href="admission-form.php" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus-circle me-2"></i>Start New Application
                            </a>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-light footer pt-5 mt-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-white mb-3">Quick Link</h4>
                    <a class="btn btn-link" href="../about.html">About Us</a>
                    <a class="btn btn-link" href="../contact.html">Contact Us</a>
                    <a class="btn btn-link" href="../courses.html">Our Courses</a>
                    <a class="btn btn-link" href="../admission.html">Admission</a>
                    <a class="btn btn-link" href="../facilities.html">Facilities</a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-white mb-3">Contact</h4>
                    <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>G-Extension, Near Model English School, Itanagar, Arunachal Pradesh</p>
                    <p class="mb-2"><i class="fa fa-phone-alt me-3"></i>+91 9862245330, +91 9208922995</p>
                    <p class="mb-2"><i class="fa fa-envelope me-3"></i>regionalinstituteofnursing@gmail.com</p>
                    <div class="d-flex pt-2">
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-twitter"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-youtube"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-white mb-3">Gallery</h4>
                    <div class="row g-2 pt-2">
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-1.jpg" alt="">
                        </div>
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-2.jpg" alt="">
                        </div>
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-3.jpg" alt="">
                        </div>
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-2.jpg" alt="">
                        </div>
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-3.jpg" alt="">
                        </div>
                        <div class="col-4">
                            <img class="img-fluid bg-light p-1" src="../img/course-1.jpg" alt="">
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-white mb-3">Newsletter</h4>
                    <p>Subscribe to our newsletter for updates</p>
                    <div class="position-relative mx-auto" style="max-width: 400px;">
                        <input class="form-control border-0 w-100 py-3 ps-4 pe-5" type="text" placeholder="Your email">
                        <button type="button" class="btn btn-primary py-2 position-absolute top-0 end-0 mt-2 me-2">SignUp</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="copyright">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        &copy; <a class="border-bottom" href="#">Regional Institute of Nursing</a>, All Right Reserved.
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <div class="footer-menu">
                            <a href="../index.html">Home</a>
                            <a href="#">Cookies</a>
                            <a href="#">Help</a>
                            <a href="#">FQAs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>


    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../lib/wow/wow.min.js"></script>
    <script src="../lib/easing/easing.min.js"></script>
    <script src="../lib/waypoints/waypoints.min.js"></script>
    <script src="../lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="../js/main.js"></script>
    
    <!-- Dashboard Javascript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check for submission success message
            if (typeof window.submissionSuccess !== 'undefined' && window.submissionSuccess === true) {
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <strong><i class="fas fa-check-circle me-2"></i>Success!</strong> Your application has been successfully submitted.
                    We will review your application and get back to you soon.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const contentContainer = document.querySelector('.col-lg-12.wow.fadeInUp');
                if (contentContainer) {
                    contentContainer.parentNode.insertBefore(successAlert, contentContainer);
                }
            }
            
            // Load user data if available
            if (typeof window.userData !== 'undefined' && window.userData !== null) {
                const userName = window.userData.first_name + ' ' + window.userData.last_name;
                
                const userNameDisplay = document.getElementById('user-name-display');
                if (userNameDisplay) {
                    userNameDisplay.textContent = userName;
                }
                
                const lastLoginDate = document.getElementById('last-login-date');
                if (lastLoginDate && window.userData.last_login) {
                    lastLoginDate.textContent = new Date(window.userData.last_login).toLocaleString();
                }
            }
            
            // Load important dates
            const importantDatesContainer = document.getElementById('important-dates-container');
            if (importantDatesContainer) {
                fetch('includes/get_important_dates.php')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.data && data.data.length > 0) {
                            importantDatesContainer.innerHTML = '';
                            data.data.forEach(date => {
                                const dateCard = document.createElement('div');
                                dateCard.className = 'date-card mb-2 p-2 border rounded';
                                
                                const formattedDate = new Date(date.date).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                                
                                let statusClass = 'primary';
                                if (date.status === 'passed') {
                                    statusClass = 'secondary';
                                } else if (date.status === 'today') {
                                    statusClass = 'success';
                                }
                                
                                dateCard.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="mb-0 fw-bold">${date.title}</p>
                                            <small class="text-muted">${formattedDate}</small>
                                        </div>
                                        <span class="badge bg-${statusClass}">
                                            ${date.status.charAt(0).toUpperCase() + date.status.slice(1)}
                                        </span>
                                    </div>
                                `;
                                
                                importantDatesContainer.appendChild(dateCard);
                            });
                        } else {
                            throw new Error(data.message || 'No important dates available');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching important dates:', error);
                        importantDatesContainer.innerHTML = `
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Error loading important dates. Please try again later.
                            </div>
                        `;
                    });
            }
        });
    </script>
</body>
</html> 